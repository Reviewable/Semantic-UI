!function(M,B){M.fn.chatroom=function(T){var L=M(this).selector||"",E=(new Date).getTime(),A=[],j=T,P="string"==typeof j,_=[].slice.call(arguments,1);return M(this).each(function(){var t,n,o,e,s,a,i=M.extend(!0,{},M.fn.chatroom.settings,T),r=i.className,u=i.namespace,l=i.selector,c=i.error,d=M(this),m=d.find(l.expandButton),p=d.find(l.userListButton),f=d.find(l.userList),h=(d.find(l.room),d.find(l.userCount)),g=d.find(l.log),v=(d.find(l.message),d.find(l.messageInput)),C=d.find(l.messageButton),y=d.data("module"),b=this,w="",x={},k={width:{log:g.width(),userList:f.outerWidth()},initialize:function(){return Pusher===B&&k.error(c.pusher),i.key===B||i.channelName===B?(k.error(c.key),!1):i.endpoint.message||i.endpoint.authentication?(a=new Pusher(i.key),Pusher.channel_auth_endpoint=i.endpoint.authentication,(t=a.subscribe(i.channelName)).bind("pusher:subscription_succeeded",k.user.list.create),t.bind("pusher:subscription_error",k.error),t.bind("pusher:member_added",k.user.joined),t.bind("pusher:member_removed",k.user.left),t.bind("update_messages",k.message.receive),M.each(i.customEvents,function(e,n){t.bind(e,n)}),p.on("click."+u,k.event.toggleUserList),m.on("click."+u,k.event.toggleExpand),v.on("keydown."+u,k.event.input.keydown).on("keyup."+u,k.event.input.keyup),C.on("mouseenter."+u,k.event.hover).on("mouseleave."+u,k.event.hover).on("click."+u,k.event.submit),g.animate({scrollTop:g.prop("scrollHeight")},400),void d.data("module",k).addClass(r.loading)):(k.error(c.endpoint),!1)},refresh:function(){p.removeClass(r.active),k.width={log:g.width(),userList:f.outerWidth()},p.hasClass(r.active)&&k.user.list.hide(),d.data("module",k)},user:{updateCount:function(){i.userCount&&(x=d.data("users"),e=0,M.each(x,function(){e++}),h.html(i.templates.userCount(e)))},joined:function(e){x=d.data("users"),"anonymous"!=e.id&&x[e.id]===B&&(x[e.id]=e.info,i.randomColor&&e.info.color===B&&(e.info.color=i.templates.color(e.id)),w=i.templates.userList(e.info),e.info.isAdmin?M(w).prependTo(f):M(w).appendTo(f),i.partingMessages&&(g.append(i.templates.joined(e.info)),k.message.scroll.test()),k.user.updateCount())},left:function(e){x=d.data("users"),e!==B&&"anonymous"!==e.id&&(delete x[e.id],d.data("users",x),f.find("[data-id="+e.id+"]").remove(),i.partingMessages&&(g.append(i.templates.left(e.info)),k.message.scroll.test()),k.user.updateCount())},list:{create:function(e){x={},e.each(function(e){"anonymous"!==e.id&&"undefined"!==e.id&&(i.randomColor&&e.info.color===B&&(e.info.color=i.templates.color(e.id)),w=e.info.isAdmin?i.templates.userList(e.info)+w:w+i.templates.userList(e.info),x[e.id]=e.info)}),d.data("users",x).data("user",x[e.me.id]).removeClass(r.loading),f.html(w),k.user.updateCount(),M.proxy(i.onJoin,f.children())()},show:function(){g.animate({width:k.width.log-k.width.userList},{duration:i.speed,easing:i.easing,complete:k.message.scroll.move})},hide:function(){g.stop().animate({width:k.width.log},{duration:i.speed,easing:i.easing,complete:k.message.scroll.move})}}},message:{scroll:{test:function(){s=g.prop("scrollHeight")-g.height(),Math.abs(g.scrollTop()-s)<i.scrollArea&&k.message.scroll.move()},move:function(){s=g.prop("scrollHeight")-g.height(),g.scrollTop(s)}},send:function(e){k.utils.emptyString(e)||M.api({url:i.endpoint.message,method:"POST",data:{message:{content:e,timestamp:(new Date).getTime()}}})},receive:function(e){o=e.data,x=d.data("users"),n=d.data("user"),x[o.userID]===B||n!==B&&n.id==o.userID||(o.user=x[o.userID],k.message.display(o))},display:function(e){g.append(i.templates.message(e)),k.message.scroll.test(),M.proxy(i.onMessage,g.children().last())()}},expand:function(){d.addClass(r.expand),M.proxy(i.onExpand,d)(),k.refresh()},contract:function(){d.removeClass(r.expand),M.proxy(i.onContract,d)(),k.refresh()},event:{input:{keydown:function(e){13==e.which&&C.addClass(r.down)},keyup:function(e){13==e.which&&(C.removeClass(r.down),k.event.submit())}},submit:function(){var e=v.val(),n=d.data("user");n===B||k.utils.emptyString(e)||(k.message.send(e),k.message.display({user:n,text:e}),k.message.scroll.move(),v.val(""))},toggleExpand:function(){d.hasClass(r.expand)?(m.removeClass(r.active),k.contract()):(m.addClass(r.active),k.expand())},toggleUserList:function(){g.is(":animated")||(p.hasClass(r.active)?(p.removeClass("active"),k.user.list.hide()):(p.addClass(r.active),k.user.list.show()))}},utils:{emptyString:function(e){return"string"==typeof e&&-1==e.search(/\S/)}},setting:function(e,n){if(n===B)return i[e];M.isPlainObject(e)?M.extend(!0,i,e):i[e]=n},internal:function(e,n){if(M.isPlainObject(e))M.extend(!0,k,e);else{if(n===B)return k[e];k[e]=n}},debug:function(){i.debug&&(i.performance?k.performance.log(arguments):(k.debug=Function.prototype.bind.call(console.info,console,i.name+":"),k.debug.apply(console,arguments)))},verbose:function(){i.verbose&&i.debug&&(i.performance?k.performance.log(arguments):(k.verbose=Function.prototype.bind.call(console.info,console,i.name+":"),k.verbose.apply(console,arguments)))},error:function(){k.error=Function.prototype.bind.call(console.error,console,i.name+":"),k.error.apply(console,arguments)},performance:{log:function(e){var n,t;i.performance&&(t=(n=(new Date).getTime())-(E||n),E=n,A.push({Element:b,Name:e[0],Arguments:[].slice.call(e,1)||"","Execution Time":t})),clearTimeout(k.performance.timer),k.performance.timer=setTimeout(k.performance.display,100)},display:function(){var e=i.name+":",t=0;E=!1,clearTimeout(k.performance.timer),M.each(A,function(e,n){t+=n["Execution Time"]}),e+=" "+t+"ms",L&&(e+=" '"+L+"'"),(console.group!==B||console.table!==B)&&0<A.length&&(console.groupCollapsed(e),console.table?console.table(A):M.each(A,function(e,n){console.log(n.Name+": "+n["Execution Time"]+"ms")}),console.groupEnd()),A=[]}},invoke:function(t,e,n){var o,s;return e=e||_,n=b||n,"string"==typeof t&&y!==B&&(t=t.split(/[\. ]/),o=t.length-1,M.each(t,function(e,n){M.isPlainObject(y[n])&&e!=o?y=y[n]:y[n]!==B?s=y[n]:k.error(c.method,t)})),M.isFunction(s)?s.apply(n,e):s||!1}};P?(y===B&&k.initialize(),k.invoke(j)):(y!==B&&k.destroy(),k.initialize())}),this},M.fn.chatroom.settings={name:"Chat",debug:!1,namespace:"chat",channel:"present-chat",onJoin:function(){},onMessage:function(){},onExpand:function(){},onContract:function(){},customEvents:{},partingMessages:!1,userCount:!0,randomColor:!0,speed:300,easing:"easeOutQuint",scrollArea:9999,endpoint:{message:!1,authentication:!1},error:{method:"The method you called is not defined",endpoint:"Please define a message and authentication endpoint.",key:"You must specify a pusher key and channel.",pusher:"You must include the Pusher library."},className:{expand:"expand",active:"active",hover:"hover",down:"down",loading:"loading"},selector:{userCount:".actions .message",userListButton:".actions .list.button",expandButton:".actions .expand.button",room:".room",userList:".room .list",log:".room .log",message:".room .log .message",author:".room log .message .author",messageInput:".talk input",messageButton:".talk .send.button"},templates:{userCount:function(e){return e+" users in chat"},color:function(e){var n=["#000000","#333333","#666666","#999999","#CC9999","#CC6666","#CC3333","#993333","#663333","#CC6633","#CC9966","#CC9933","#999966","#CCCC66","#99CC66","#669933","#669966","#33A3CC","#336633","#33CCCC","#339999","#336666","#336699","#6666CC","#9966CC","#333399","#663366","#996699","#993366","#CC6699"];return n[Math.floor(Math.random()*n.length)]},message:function(e){var n="";return e.user.isAdmin?(e.user.color="#55356A",n+='<div class="admin message"><span class="quirky ui flag team"></span>'):n+='<div class="message">',n+="<p>",e.user.color!==B?n+='<span class="author" style="color: '+e.user.color+';">'+e.user.name+"</span>: ":n+='<span class="author">'+e.user.name+"</span>: ",n+=e.text+" </p></div>"},joined:function(e){return typeof e.name!==B&&'<div class="status">'+e.name+" has joined the chat.</div>"},left:function(e){return typeof e.name!==B&&'<div class="status">'+e.name+" has left the chat.</div>"},userList:function(e){var n="";return e.isAdmin&&(e.color="#55356A"),n+='<div class="user" data-id="'+e.id+'"> <div class="image">   <img src="'+e.avatarURL+'"> </div>',e.color!==B?n+=' <p><a href="/users/'+e.id+'" target="_blank" style="color: '+e.color+';">'+e.name+"</a></p>":n+=' <p><a href="/users/'+e.id+'" target="_blank">'+e.name+"</a></p>",n+="</div>"}}}}(jQuery,(window,void document));